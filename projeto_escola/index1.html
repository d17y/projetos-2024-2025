<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" /> <!-- Permite acentuação e caracteres especiais -->
  <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- Faz o site responsivo -->
  <title>Verificação por SMS - Banco Seguro</title> <!-- Título da página -->

  <style>
    /* Estilo base da página */
    body{
      margin:0; /* Remove margens padrão */
      font-family: Arial, sans-serif; /* Fonte padrão */
      height:100vh; /* Altura total da tela */
      display:flex; /* Flexbox para centralizar container */
      align-items:center; /* Centraliza verticalmente */
      justify-content:center; /* Centraliza horizontalmente */
      background: linear-gradient(to bottom, #d6f817, #bec928); /* Fundo degradê */
      color:#fff; /* Cor do texto */
    }

    /* Container central */
    .container{
      width:90%; /* Largura relativa à tela */
      max-width:420px; /* Largura máxima */
      background: rgba(0,0,0,0.2); /* Fundo semi-transparente */
      padding:28px; /* Espaçamento interno */
      border-radius:18px; /* Bordas arredondadas */
      box-shadow: 0 8px 20px rgba(0,0,0,0.3); /* Sombra */
      text-align:center; /* Centraliza o texto */
      position:relative; /* Para posicionamento interno */
    }

    h1{ margin:0 0 12px; font-size:20px } /* Título */
    p.desc{ margin:6px 0 18px; color:#eaf9ff } /* Descrição do formulário */

    /* Input do código */
    #campoCodigo{
      width:100%; /* Largura total do container */
      padding:12px; /* Espaçamento interno */
      border-radius:10px; /* Bordas arredondadas */
      border:none; /* Sem borda */
      font-size:18px; /* Tamanho do texto */
      text-align:center; /* Texto centralizado */
      outline:none; /* Remove contorno */
      box-sizing:border-box; /* Inclui padding na largura */
      margin-bottom:14px; /* Espaço abaixo */
    }

    /* Botões */
    .botao{
      display:inline-block;
      padding:10px 18px;
      border-radius:12px;
      background:#004d63; /* Fundo azul escuro */
      color:#fff;
      font-weight:bold;
      cursor:pointer;
      border:none;
      margin-top:8px;
    }

    .botao.ghost{
      background: rgba(255,255,255,0.85); /* Fundo semi-claro */
      color:#004d63; /* Texto azul */
      font-style:italic; /* Itálico */
      margin-left:8px;
    }

    /* Mensagem de feedback */
    .msg { 
      margin-top:14px; 
      min-height:22px; 
      font-weight:bold;
    }

    /* Notificação falsa de SMS */
    .fake-sms {
      position:fixed; /* Fixa no topo da tela */
      left:50%; /* Centraliza horizontalmente */
      transform:translateX(-50%) translateY(-120%); /* Inicialmente fora da tela */
      top:16px; /* Distância do topo */
      width:320px; 
      max-width:86%;
      background:#fff; /* Fundo branco */
      color:#111; /* Texto escuro */
      border-radius:12px; /* Bordas arredondadas */
      padding:12px 14px; /* Espaçamento interno */
      box-shadow:0 8px 24px rgba(0,0,0,0.35); /* Sombra */
      display:flex; /* Flex para alinhar número e texto */
      gap:10px; /* Espaçamento entre elementos */
      align-items:center; /* Centraliza verticalmente */
      transition: transform 0.45s cubic-bezier(.2,.9,.2,1); /* Animação suave */
      z-index:9999;
    }

    /* Classe que desliza a notificação para dentro */
    .fake-sms.mostrar { transform: translateX(-50%) translateY(0%); }

    /* Número do remetente */
    .fake-sms .numero { font-size:12px; color:#666; }
    .fake-sms .texto { font-size:15px; font-weight:600; }

    /* Botão para fechar notificação */
    .fechar-sms { margin-left:auto; cursor:pointer; font-weight:bold; color:#666; }

    /* Telefone exibido no topo */
    .telefone { color:#cfeffb; margin-bottom:8px; font-size:14px; }
  </style>
</head>

<body>
  <!-- Container principal -->
  <div class="container">
    <h1>Verificação por SMS</h1>
    <p class="desc">Enviamos um código para o número cadastrado. Insira o código abaixo.</p>

    <!-- Telefone do usuário -->
    <p id="telefoneExib" class="telefone">Número: (carregando...)</p>

    <!-- Input do código (6 dígitos) -->
    <input id="campoCodigo" type="text" inputmode="numeric" maxlength="6" placeholder="000000">

    <!-- Botões -->
    <div>
      <button id="btnVerificar" class="botao">Verificar código</button>
      <button id="btnReenviar" class="botao ghost">Reenviar código</button>
    </div>

    <!-- Mensagem de feedback -->
    <div id="msg" class="msg"></div>
  </div>

  <!-- Notificação falsa simulando SMS -->
  <div id="fakeSms" class="fake-sms" aria-hidden="true" style="display:none">
    <div>
      <div class="numero" id="smsNumero">+55 (xx) xxxxx-xxxx</div>
      <div class="texto" id="smsTexto">Seu código: 000000</div>
    </div>
    <div class="fechar-sms" id="fecharSms">✕</div>
  </div>

  <script>
    // Pega CPF logado da página anterior
    const cpfLogado = localStorage.getItem('ultimo_cpf_logado');

    // Recupera todos os usuários do localStorage
    const usuarios = JSON.parse(localStorage.getItem('banco_usuarios') || '{}');

    // Prefixo para salvar OTP no localStorage
    const OTP_KEY_PREFIX = 'otp_for_';

    // Função para gerar código OTP de 6 dígitos
    function gerarOTP(){ return Math.floor(100000 + Math.random()*900000).toString(); }

    // Salva OTP para CPF com expiração
    function salvarOtpParaCpf(cpf, otp, minutos=5){
      const exp = Date.now() + minutos*60*1000;
      const payload = { otp, exp };
      localStorage.setItem(OTP_KEY_PREFIX + cpf, JSON.stringify(payload));
    }

    // Lê OTP salvo; retorna null se expirou ou não existe
    function lerOtpParaCpf(cpf){
      const raw = localStorage.getItem(OTP_KEY_PREFIX + cpf);
      if(!raw) return null;
      try {
        const obj = JSON.parse(raw);
        if(obj.exp && Date.now() > obj.exp){ localStorage.removeItem(OTP_KEY_PREFIX + cpf); return null; }
        return obj.otp;
      } catch(e){ return null; }
    }

    // Remove OTP
    function limparOtp(cpf){ localStorage.removeItem(OTP_KEY_PREFIX + cpf); }

    // Mostra notificação falsa com código
    function mostrarSmsFalso(numeroTexto, textoSms){
      const fake = document.getElementById('fakeSms');
      document.getElementById('smsNumero').innerText = numeroTexto;
      document.getElementById('smsTexto').innerText = textoSms;
      fake.style.display = 'flex';
      requestAnimationFrame(()=> fake.classList.add('mostrar'));
      fake.setAttribute('aria-hidden','false');
      setTimeout(()=> esconderSmsFalso(), 4500); // some após 4,5s
    }

    // Esconde notificação
    function esconderSmsFalso(){
      const fake = document.getElementById('fakeSms');
      fake.classList.remove('mostrar');
      fake.setAttribute('aria-hidden','true');
      setTimeout(()=> { fake.style.display = 'none'; }, 500);
    }

    // Envia código simulado
    function enviarCodigoSimulado(){
      if(!cpfLogado) { showMsg('Usuário não identificado. Volte e faça login.', 'rgba(255,80,80,0.25)'); return; }
      const user = usuarios[cpfLogado];
      if(!user){ showMsg('Usuário não encontrado.', 'rgba(255,80,80,0.25)'); return; }
      const tel = user.telefone || 'não informado';
      const otp = gerarOTP(); // gera código
      salvarOtpParaCpf(cpfLogado, otp, 5); // expira em 5 min
      mostrarSmsFalso(formatarTelefoneExib(tel), 'Seu código de verificação: ' + otp);
      document.getElementById('telefoneExib').innerText = 'Número: ' + formatarTelefoneExib(tel);
    }

    // Formata telefone
    function formatarTelefoneExib(nums){
      if(!nums) return 'não informado';
      const s = nums.replace(/\D/g,'');
      if(s.length <= 2) return '('+s+')';
      if(s.length <= 6) return '('+s.slice(0,2)+') '+s.slice(2);
      if(s.length <= 10) return '('+s.slice(0,2)+') '+s.slice(2,6)+'-'+s.slice(6);
      return '('+s.slice(0,2)+') '+s.slice(2,7)+'-'+s.slice(7);
    }

    // Mostra mensagem
    function showMsg(txt, bg='transparent'){
      const el = document.getElementById('msg');
      el.innerText = txt;
      el.style.color = '#fff';
      el.style.background = bg==='transparent'? 'transparent': bg;
    }

    // Ao carregar a página
    document.addEventListener('DOMContentLoaded', ()=>{
      if(!cpfLogado){ showMsg('Acesso inválido — faça login primeiro.', 'rgba(255,80,80,0.25)'); return; }
      enviarCodigoSimulado(); // envia código automaticamente
    });

    // Reenviar código
    document.getElementById('btnReenviar').addEventListener('click', ()=>{
      enviarCodigoSimulado();
      showMsg('Código reenviado (simulado).', 'rgba(0,128,0,0.12)');
    });

    // Fechar notificação
    document.getElementById('fecharSms').addEventListener('click', esconderSmsFalso);

    // Verificar código
    document.getElementById('btnVerificar').addEventListener('click', ()=>{
      const input = document.getElementById('campoCodigo').value.trim();
      if(!input || input.length < 6){ showMsg('Digite o código de 6 dígitos.', 'rgba(255,140,0,0.20)'); return; }
      const otpSalvo = lerOtpParaCpf(cpfLogado);
      if(!otpSalvo){ showMsg('Código expirado. Reenvie para receber outro.', 'rgba(255,80,80,0.25)'); return; }

      // Se o código estiver correto
      if(input === otpSalvo){
        limparOtp(cpfLogado); // remove OTP
        showMsg('✅ Código correto — redirecionando...', 'rgba(0,128,0,0.15)');

        // Redireciona automaticamente para index2.html após 1 segundo
        setTimeout(()=> { window.location.href = 'index2.html'; }, 1000);

      } else { // Código incorreto
        showMsg('❌ Código incorreto. Tente novamente.', 'rgba(255,0,0,0.20)');
      }
    });
  </script>
</body>
</html>
